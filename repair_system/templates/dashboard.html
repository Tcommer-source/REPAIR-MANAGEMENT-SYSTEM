<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üìä Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: radial-gradient(circle at top left, #e0e5ec, #f0f2f5); color: #444; font-family: 'Sarabun', sans-serif; min-height: 100vh; }
        .nav-bar { background: linear-gradient(145deg, #1a2a6c, #142152); color: white; padding: 15px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .filter-card, .chart-box { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 25px; margin-bottom: 25px; box-shadow: 15px 15px 35px #d1d9e6, -15px -15px 35px #ffffff; border: 1px solid rgba(255, 255, 255, 0.5); }
        .stat-card { border-radius: 20px; padding: 25px; text-align: center; color: white; margin-bottom: 20px; border: none; box-shadow: 0 15px 35px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
        .bg-3d-blue { background: linear-gradient(145deg, #3a7bd5, #00d2ff); }
        .bg-3d-orange { background: linear-gradient(145deg, #f2994a, #f2c94c); color: #333 !important; }
        .bg-3d-cyan { background: linear-gradient(145deg, #2193b0, #6dd5ed); }
        .bg-3d-green { background: linear-gradient(145deg, #11998e, #38ef7d); }
        .stat-card h3 { font-size: 2.5rem; font-weight: 800; }
        .pie-container { max-width: 300px; margin: 0 auto; height: 300px; } 
        .job-scroll { height: 380px; overflow-y: auto; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background-color: rgba(0,0,0,0.05) !important; }
    </style>
</head>
<body>

<div class="nav-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="m-0"><i class="fas fa-chart-line me-2"></i>Repair Service Dashboard</h4>
        <div>
            <a href="/" class="btn btn-outline-light btn-sm rounded-pill me-2">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <a href="/logout" class="btn btn-danger btn-sm rounded-pill">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="filter-card">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label small fw-bold text-primary">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                <select name="year" class="form-select rounded-pill">
                    <option value="all" {% if selected_year == 'all' %}selected{% endif %}>-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    {% for y in years %}
                    <option value="{{ y }}" {% if selected_year == y|string %}selected{% endif %}>‡∏õ‡∏µ {{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-primary">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
                <select name="user" class="form-select rounded-pill">
                    <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    {% for u in users %}<option value="{{ u }}" {% if request.args.get('user') == u %}selected{% endif %}>{{ u }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-primary">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                <select name="department" class="form-select rounded-pill">
                    <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    {% for d in departments %}<option value="{{ d }}" {% if request.args.get('department') == d %}selected{% endif %}>{{ d }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" name="date_start" class="form-control rounded-pill" value="{{ request.args.get('date_start','') }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" name="date_end" class="form-control rounded-pill" value="{{ request.args.get('date_end','') }}">
            </div>
            <div class="col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-primary flex-grow-1 fw-bold rounded-pill shadow-sm">üîç ‡∏Å‡∏£‡∏≠‡∏á</button>
                <a href="/dashboard" class="btn btn-secondary rounded-pill shadow-sm">‡∏•‡πâ‡∏≤‡∏á</a>
                <a href="/export_excel?year={{ selected_year }}&user={{ request.args.get('user','') }}&department={{ request.args.get('department','') }}&date_start={{ request.args.get('date_start','') }}&date_end={{ request.args.get('date_end','') }}" 
                   class="btn btn-success rounded-pill shadow-sm" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel"><i class="fas fa-file-excel"></i></a>
            </div>
        </form>
    </div>

    <div class="row text-center">
        <div class="col-md-3"><div class="stat-card bg-3d-blue"><h6>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6><h3>{{ total }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card bg-3d-orange"><h6>‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</h6><h3>{{ data['Open'] }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card bg-3d-cyan"><h6>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h6><h3>{{ data['In Progress'] }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card bg-3d-green"><h6>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h6><h3>{{ data['Done'] }} <small style="font-size: 1.1rem; opacity: 0.8;">({{ percent_done }}%)</small></h3></div></div>
    </div>

    <div class="row mt-3">
        <div class="col-md-5">
            <div class="chart-box text-center" style="height: 500px;">
                <h6 class="fw-bold mb-4 text-muted border-bottom pb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h6>
                <div class="pie-container"><canvas id="pieChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="chart-box" style="height: 500px;">
                <h6 class="fw-bold mb-3 text-muted border-bottom pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h6>
                <div class="job-scroll">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody>
                            {% for status, jobs in job_lists.items() %}{% for job in jobs %}
                            <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#jobModal" 
                                data-id="{{ job.id }}" data-user="{{ job.user }}" data-dept="{{ job.department }}" 
                                data-cat="{{ job.category }}" data-detail="{{ job.detail }}" data-status="{{ status }}" 
                                data-date="{{ job.created_at.strftime('%d/%m/%Y %H:%M') }}" 
                                data-note="{{ job.progress_note if job.progress_note else '-' }}">
                                <td class="small">{{ job.created_at.strftime('%d/%m/%y') }}</td>
                                <td class="fw-bold">{{ job.user }}</td>
                                <td class="small">{{ job.category }}</td>
                                <td class="text-center"><span class="badge rounded-pill {% if status=='Done' %}bg-success{% elif status=='Open' %}bg-warning text-dark{% else %}bg-info{% endif %} shadow-sm">{{ status }}</span></td>
                            </tr>
                            {% endfor %}{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5 mt-2">
        <div class="col-md-5">
            <div class="chart-box" style="height: 480px;"><h6 class="text-center fw-bold text-muted border-bottom pb-2 mb-4">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6><canvas id="catChart"></canvas></div>
        </div>
        <div class="col-md-7">
            <div class="chart-box" style="height: 480px;"><h6 class="text-center fw-bold text-muted border-bottom pb-2 mb-4">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Top 10)</h6><canvas id="userChart"></canvas></div>
        </div>
    </div>
</div>

<div class="modal fade" id="jobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-header bg-light" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title fw-bold text-primary"><i class="fas fa-clipboard-list me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-6"><label class="small text-muted">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label><div id="m-user" class="fw-bold"></div></div>
                    <div class="col-6"><label class="small text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label><div id="m-dept"></div></div>
                    <div class="col-6"><label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</label><div id="m-date" class="small"></div></div>
                    <div class="col-6"><label class="small text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><div><span id="m-status" class="badge rounded-pill"></span></div></div>
                    <div class="col-12"><hr class="my-2"></div>
                    <div class="col-12"><label class="small text-muted text-primary fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label><div id="m-detail" class="p-3 bg-light rounded shadow-sm"></div></div>
                    <div class="col-12"><label class="small text-muted text-info">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</label><div id="m-note" class="fst-italic text-secondary"></div></div>
                </div>
            </div>
            <div class="modal-footer bg-light" style="border-radius: 0 0 20px 20px;">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <a id="m-edit-btn" href="#" class="btn btn-primary rounded-pill px-4"><i class="fas fa-tools me-1"></i> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const barConfig = {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { 
            x: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1, precision: 0 } },
            y: { grid: { display: false }, ticks: { font: { weight: 'bold' } } }
        }
    };

    // 1. Pie Chart
    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { labels: ['Open', 'In Progress', 'Done'], datasets: [{ data: [{{ data['Open'] }}, {{ data['In Progress'] }}, {{ data['Done'] }}], backgroundColor: ['#f2994a', '#2d9cdb', '#27ae60'] }] },
        options: { cutout: '55%', plugins: { legend: { position: 'bottom' } } }
    });

    // 2. Category Chart
    new Chart(document.getElementById('catChart'), { 
        type: 'bar', data: { labels: {{ category_labels|safe }}, datasets: [{ data: {{ category_counts|safe }}, backgroundColor: '#f2994a', borderRadius: 8 }] }, options: barConfig 
    });

    // 3. User Chart
    new Chart(document.getElementById('userChart'), { 
        type: 'bar', data: { labels: {{ user_labels|safe }}, datasets: [{ data: {{ user_counts|safe }}, backgroundColor: '#2d9cdb', borderRadius: 8 }] }, options: barConfig 
    });

    // Modal Handle
    const modal = document.getElementById('jobModal');
    modal.addEventListener('show.bs.modal', function (e) {
        const b = e.relatedTarget;
        document.getElementById('m-user').textContent = b.getAttribute('data-user');
        document.getElementById('m-dept').textContent = b.getAttribute('data-dept');
        document.getElementById('m-date').textContent = b.getAttribute('data-date');
        document.getElementById('m-detail').textContent = b.getAttribute('data-detail');
        document.getElementById('m-note').textContent = b.getAttribute('data-note');
        document.getElementById('m-edit-btn').href = '/?id=' + b.getAttribute('data-id');
        const st = b.getAttribute('data-status');
        const badge = document.getElementById('m-status');
        badge.textContent = st;
        badge.className = 'badge rounded-pill ' + (st === 'Done' ? 'bg-success' : (st === 'Open' ? 'bg-warning text-dark' : 'bg-info'));
    });
</script>
</body>
</html>
